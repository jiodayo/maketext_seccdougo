"""
è¬›æ¼”ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¢ãƒ—ãƒª
=====================
è¬›æ¼”ã®ãƒ¡ãƒ¢ã‚„æ›¸ãèµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€
OpenAI GPT ã‚’ä½¿ã£ã¦æ§‹é€ åŒ–ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
"""

import os

import streamlit as st
from dotenv import load_dotenv
from openai import OpenAI, APIError, AuthenticationError

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è¨­å®š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()

MODEL_NAME = "gpt-4o"
TEMPERATURE = 0.3

SYSTEM_PROMPT = (
    "ã‚ãªãŸã¯ä¼æ¥­ã®åºƒå ±æ‹…å½“ã€ã¾ãŸã¯ã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚"
    "æä¾›ã•ã‚ŒãŸè¬›æ¼”ãƒ¡ãƒ¢ã‚„å¯¾è«‡å†…å®¹ã«åŸºã¥ãã€è¦ç‚¹ã‚’æ•´ç†ã—ã¦"
    "æ ¼èª¿é«˜ã„ãƒ“ã‚¸ãƒã‚¹å ±å‘Šæ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"
)

USER_PROMPT_TEMPLATE = """\
ä»¥ä¸‹ã®ã€è¬›æ¼”ãƒ‡ãƒ¼ã‚¿ã€‘ã‚’ã‚‚ã¨ã«ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€åˆ¶ç´„äº‹é …ã€‘
- æ§‹æˆ: ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ã€Œå°å…¥ï¼ˆç™»å£‡è€…ãƒ»ãƒ†ãƒ¼ãƒï¼‰ã€ã€Œå†…å®¹ã®è¦ç´„ã€ã€Œä»˜åŠ çš„ãªè­°è«–ã€ã®é †ã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚
- æ–‡å­—æ•°: æœ¬æ–‡ã¯350æ–‡å­—ã€œ400æ–‡å­—ç¨‹åº¦ã«ã¾ã¨ã‚ã‚‹ã“ã¨(å³å®ˆ)ã€‚
- ãƒˆãƒ¼ãƒ³: ã ãƒ»ã§ã‚ã‚‹èª¿ï¼ˆæ•¬ä½“ï¼‰ã‚’ä½¿ç”¨ã—ã€å®¢è¦³çš„ã‹ã¤ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¡¨ç¾ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚

ã€è¬›æ¼”ãƒ‡ãƒ¼ã‚¿ã€‘
{lecture_text}

ã€å‡ºåŠ›å½¢å¼ã€‘
ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçŸ­ã„è¦‹å‡ºã—ï¼‰

æœ¬æ–‡ï¼ˆ350ã€œ400æ–‡å­—ç¨‹åº¦ï¼‰
"""


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OpenAI å‘¼ã³å‡ºã—
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def generate_report(lecture_text: str, api_key: str) -> str:
    """è¬›æ¼”ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦è¿”ã™ã€‚"""
    client = OpenAI(api_key=api_key)

    user_prompt = USER_PROMPT_TEMPLATE.format(lecture_text=lecture_text)

    response = client.chat.completions.create(
        model=MODEL_NAME,
        temperature=TEMPERATURE,
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt},
        ],
    )

    return response.choices[0].message.content


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main() -> None:
    st.set_page_config(
        page_title="è¬›æ¼”ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ",
        page_icon="ğŸ“",
        layout="centered",
    )

    st.title("ğŸ“ è¬›æ¼”ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¢ãƒ—ãƒª")
    st.caption(
        "è¬›æ¼”ã®ãƒ¡ãƒ¢ã‚„æ›¸ãèµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€"
        "GPT ãŒç´„350ã€œ400æ–‡å­—ã®æ§‹é€ åŒ–ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚"
    )

    # --- APIã‚­ãƒ¼ç¢ºèª ---
    api_key = os.getenv("OPENAI_API_KEY", "")
    if not api_key:
        st.error(
            "âš ï¸ OpenAI API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n"
            "`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã« `OPENAI_API_KEY=sk-...` ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\n\n"
            "ï¼ˆ`.env.example` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ï¼‰"
        )
        st.stop()

    # --- å…¥åŠ› ---
    st.subheader("è¬›æ¼”ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›")
    lecture_text = st.text_area(
        label="è¬›æ¼”ãƒ¡ãƒ¢ãƒ»æ›¸ãèµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„",
        height=300,
        placeholder=(
            "ä¾‹:\n"
            "æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯CIOãƒ‘ãƒãƒ«ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€\n"
            "â—‹â—‹æ°ã¨â–³â–³æ°ãŒç™»å£‡ã—ã€ITåˆ©æ´»ç”¨ã®ç¾çŠ¶ã¨èª²é¡Œã«ã¤ã„ã¦\n"
            "è­°è«–ãŒè¡Œã‚ã‚ŒãŸâ€¦â€¦"
        ),
    )

    # --- ç”Ÿæˆãƒœã‚¿ãƒ³ ---
    if st.button("ğŸš€ ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ", type="primary", use_container_width=True):
        if not lecture_text.strip():
            st.warning("è¬›æ¼”ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            return

        with st.spinner("ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­ã§ã™â€¦"):
            try:
                report = generate_report(lecture_text, api_key)
            except AuthenticationError:
                st.error(
                    "âŒ API ã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚`.env` ã® `OPENAI_API_KEY` ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                )
                return
            except APIError as e:
                st.error(f"âŒ OpenAI API ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n{e}")
                return
            except Exception as e:
                st.error(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n{e}")
                return

        # --- çµæœè¡¨ç¤º ---
        st.divider()
        st.subheader("ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ")
        st.markdown(report)

        # ã‚³ãƒ”ãƒ¼ç”¨ã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã‚‚è¡¨ç¤º
        with st.expander("ğŸ“‹ ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰"):
            st.code(report, language=None)


if __name__ == "__main__":
    main()
